<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<script>
			var nodes = [];
			var state = 0;
			var IDCounter = 0;

			var IDLE = 0;
			var ADDNODE = 1;
			var ADDBRANCH1 = 2;
			var ADDBRANCH2 = 3;
			var REMOVENODE = 4;

			var	node1;
			var node2;
			
			// Variables to do with dragging
			var offsetx = 0;
			var offsety = 0;
			var initialx;
			var initialy;
			var tempx;
			var tempy;
			var dragging = false;
			
			var temppath = [];
			
			function addNode() {
				state = ADDNODE;
				message = document.getElementById("action-message");
				message.innerHTML = "Please click somewhere to add a node.";
			}

			function addBranch() {
				state = ADDBRANCH1;
				message = document.getElementById("action-message");
				message.innerHTML = "Please select the first node.";
			}

			function removeNode() {
				state = REMOVENODE;
				message = document.getElementById("action-message");
				message.innerHTML = "Please select the node you wish to delete.";
			}

			function canvasClick(event) {
				var canvas = document.getElementById("canvas");
				var ctx = canvas.getContext("2d");
				
				var rect = canvas.getBoundingClientRect();
				var x = event.clientX - rect.left - offsetx;
				var y = event.clientY - rect.top - offsety;
				
				if (state == ADDNODE) {
					message = document.getElementById("action-message");
					message.innerHTML = "";
					
					var variablename = window.prompt("Please enter a variable name.","")
					while (variablename == null || variablename == "") {
						if (variablename == "") {
							variablename = window.prompt("Variable name cannot be blank.\n\nPlease enter a variable name.","");
						}
						else {
							variablename = window.prompt("Please enter a variable name.","");
						}
					}
					
					nodes.push({id: IDCounter,type: "node",variable: variablename,x: x,y: y,branches: []})
					IDCounter = IDCounter + 1;

					state = IDLE;
				}
				else if (state == ADDBRANCH1) {
					for (var i = 0; i < nodes.length; i++) {
						if (Math.pow((x-nodes[i].x),2) + Math.pow((y-nodes[i].y),2) <= Math.pow(50,2)) {
							node1 = nodes[i].id;
							message = document.getElementById("action-message");
							message.innerHTML = "Please select the second node (or click elsewhere to create an intermediate point).";
							state = ADDBRANCH2;
						}
					}
				}
				else if (state == ADDBRANCH2) {
					var found = false;
					for (var i = 0; i < nodes.length; i++) {
						if (Math.pow((x-nodes[i].x),2) + Math.pow((y-nodes[i].y),2) <= Math.pow(50,2)) {
							found = true;
							node2 = nodes[i].id;
							message = document.getElementById("action-message");
							message.innerHTML = "";
							for (var j = 0; j < nodes.length; j++) {
								if (nodes[j].id == node1) {
									nodes[j].branches.push({id: IDCounter,type: "branch",destNode: node2,path: temppath});
									temppath = [];
									IDCounter = IDCounter + 1;
								}
							}
							state = IDLE;
							break;
						}
					}
					if (!found) {
						temppath.push({x: x,y: y});
					}
				}
				else if (state == REMOVENODE) {
					for (var i = 0; i < nodes.length; i++) {
						if (Math.pow((x-nodes[i].x),2) + Math.pow((y-nodes[i].y),2) <= Math.pow(50,2)) {
							message = document.getElementById("action-message");
							message.innerHTML = "";
							for (var j = 0; j < nodes.length; j++) {
								for (var k = 0; k < nodes[j].branches.length; k++) {
									if (nodes[j].branches[k].destNode == nodes[i].id) {
										nodes[j].branches.splice(k,1);
										k--;
									}
								}
							}
							nodes.splice(i,1);
							state = IDLE;
						}
					}
				}
				
				draw();
			}
			
			function initialize() {
				var canvas = document.getElementById("canvas");
				var ctx = canvas.getContext("2d");

				canvas.width = window.innerWidth - 400;
				canvas.height = window.innerHeight - 100;

				canvas.addEventListener("click",function(event) {canvasClick(event)},false);
				canvas.addEventListener("mousedown",function(event) {dragging = true;
				initialx = event.clientX;
				initialy = event.clientY;
				tempx = initialx;
				tempy = initialy;},false);
				window.addEventListener("mousemove",function(event) {
				if (dragging) {
					tempx = event.clientX;
					tempy = event.clientY;
					offsetx = offsetx + tempx - initialx;
					offsety = offsety + tempy - initialy;
					initialx = tempx;
					initialy = tempy;
					draw();
				}},false)
				window.addEventListener("mouseup",function(event) {dragging = false;},false);
			}


			function drawNode(ctx,text,x,y) {
				ctx.beginPath();
				ctx.arc(x,y,50,0,2*Math.PI);
				ctx.fillStyle = "white";
				ctx.fill();
				ctx.fillStyle = "black";
				ctx.font="14px Arial";
				for (var i = 14;i >= 1;i--) {
					ctx.font = i.toString().concat("px Arial");
					if (ctx.measureText(text).width <= 90) {
						break;
					}
				}
				ctx.fillText(text,x-ctx.measureText(text).width/2,y+7);
				ctx.stroke();
			}

			function draw() {
				var canvas = document.getElementById("canvas");
				var ctx = canvas.getContext("2d");

				// Clear Canvas
				ctx.clearRect(0,0, canvas.width, canvas.height)
				
				
				for (var i = 0; i < nodes.length; i++) {
					// Draw Branches
					for (var j = 0; j < nodes[i].branches.length; j++) {
						for (var k = 0; k < nodes.length; k++) {
							if (nodes[k].id == nodes[i].branches[j].destNode) {
								// Draw Line
								ctx.beginPath();
								ctx.moveTo(nodes[i].x + offsetx, nodes[i].y + offsety);
								// Draw intermediate points
								for (var l = 0; l < nodes[i].branches[j].path.length; l++) {
									ctx.lineTo(nodes[i].branches[j].path[l].x + offsetx, nodes[i].branches[j].path[l].y + offsety);
								}
								ctx.lineTo(nodes[k].x + offsetx, nodes[k].y + offsety);
								ctx.stroke();
							}
						}
					}
				}
				
				// Draw Nodes
				for (var i = 0; i < nodes.length; i++) {
					drawNode(ctx,nodes[i].variable,nodes[i].x + offsetx,nodes[i].y + offsety);
				}
			}
		</script>
	</head>
	<body onload="initialize();" class="" id="body">
		<div>
			<div style="float: left">
				<canvas id="canvas" style="border-style: solid;" "="" width="1280" height="836"></canvas>
			</div>
			<div style="float: left; width: 350px;">
				<center>
					Signal Flow Graph Visualizer
					<p id="action-message">
					</p>
					
					<div><button onclick="addNode();">
					Add Node
					</button></div>
					<div><button onclick="addBranch();">
					Add Branch
					</button></div>
					<div><button onclick="removeNode();">
					Remove Node
					</button></div>
				</center>
			</div>
		<div>
	

</div></div>
</body></html>
